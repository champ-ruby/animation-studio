<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Animation Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
body {
  margin:0;
  background:#111;
  color:white;
  font-family:sans-serif;
  display:grid;
  grid-template-columns:160px 1fr 220px;
  grid-template-rows:auto 1fr 160px;
}
header {
  grid-column:1/4;
  background:#000;
  padding:6px;
  text-align:center;
}
button,input {
  margin:3px;
  font-size:14px;
}
#assets,#inspector {
  padding:6px;
  overflow:auto;
}
#assets { border-right:1px solid #333; }
#inspector { border-left:1px solid #333; }
#stage {
  background:black;
  touch-action:none;
}
#timeline {
  grid-column:1/4;
  border-top:1px solid #333;
  padding:6px;
}
.scene {
  border:1px solid #333;
  padding:4px;
  margin-bottom:4px;
  cursor:pointer;
}
.scene.active {
  border-color:cyan;
}
</style>

<!-- ===============================
     APP LOGIC + FIREBASE
================================ -->
<script type="module">

/* ---------- OPTIONAL FIREBASE ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* üî¥ OPTIONAL: PASTE FIREBASE CONFIG HERE üî¥ */
const firebaseConfig = {
  apiKey: "",
  authDomain: "",
  projectId: "",
  storageBucket: "",
  messagingSenderId: "",
  appId: ""
};

let db=null, user=null, cloudOK=false;

try {
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  db = getFirestore(app);
  await signInAnonymously(auth);
  user = auth.currentUser;
  cloudOK = true;
} catch(e) {
  console.warn("Running in local SAFE MODE");
}

/* ---------- DATA MODEL ---------- */
let project = {
  name:"My Animation",
  scenes:[{ objects:[] }],
  current:0
};

class Obj {
  constructor(type){
    this.type = type;
    this.x = 100;
    this.y = 120;
    this.vx = 1;
    this.vy = 0;
    this.layer = 0;
  }
}

const canvas = document.getElementById("stage");
const ctx = canvas.getContext("2d");
let selected=null, playing=false;

function scene(){ return project.scenes[project.current]; }

/* ---------- DRAW ---------- */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  scene().objects
    .sort((a,b)=>a.layer-b.layer)
    .forEach(o=>{
      ctx.fillStyle="white";
      if(o.type==="ball"){
        ctx.beginPath();
        ctx.arc(o.x,o.y,15,0,Math.PI*2);
        ctx.fill();
      } else {
        ctx.fillRect(o.x-2,o.y-30,4,30);
      }
    });
}

/* ---------- PLAY ---------- */
function loop(){
  if(!playing) return;
  scene().objects.forEach(o=>{
    o.vy+=0.4;
    o.x+=o.vx;
    o.y+=o.vy;
    if(o.y>240){ o.y=240; o.vy*=-0.6; }
  });
  draw();
  requestAnimationFrame(loop);
}

window.play = ()=>{
  playing=!playing;
  if(playing) loop();
};

/* ---------- OBJECTS ---------- */
window.addBall = ()=>{
  scene().objects.push(new Obj("ball"));
  draw();
};
window.addStick = ()=>{
  scene().objects.push(new Obj("stick"));
  draw();
};

/* ---------- TOUCH DRAG ---------- */
canvas.addEventListener("pointerdown",e=>{
  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left;
  const y=e.clientY-r.top;
  scene().objects.forEach(o=>{
    if(Math.abs(o.x-x)<20 && Math.abs(o.y-y)<20) selected=o;
  });
});
canvas.addEventListener("pointermove",e=>{
  if(!selected||playing) return;
  const r=canvas.getBoundingClientRect();
  selected.x=e.clientX-r.left;
  selected.y=e.clientY-r.top;
  draw();
});
canvas.addEventListener("pointerup",()=>selected=null);

/* ---------- SCENES ---------- */
window.newScene = ()=>{
  project.scenes.push({objects:[]});
  project.current = project.scenes.length-1;
  refreshScenes();
  draw();
};

function refreshScenes(){
  const list=document.getElementById("sceneList");
  list.innerHTML="";
  project.scenes.forEach((s,i)=>{
    const d=document.createElement("div");
    d.className="scene"+(i===project.current?" active":"");
    d.textContent="Scene "+(i+1);
    d.onclick=()=>{
      project.current=i;
      refreshScenes();
      draw();
    };
    list.appendChild(d);
  });
}
refreshScenes();
draw();

/* ---------- CLOUD SAVE ---------- */
window.saveCloud = async()=>{
  if(!cloudOK) return alert("Cloud unavailable");
  await setDoc(doc(db,"projects",project.name),project);
  alert("Saved");
};
window.loadCloud = async()=>{
  if(!cloudOK) return alert("Cloud unavailable");
  const snap = await getDoc(doc(db,"projects",project.name));
  if(snap.exists()){ project=snap.data(); refreshScenes(); draw(); }
};

</script>
</head>

<body>

<header>
  <button onclick="play()">‚ñ∂ Play</button>
  <button onclick="addBall()">‚ûï Ball</button>
  <button onclick="addStick()">‚ûï Stick</button>
  <button onclick="newScene()">üß© Scene</button>
  <button onclick="saveCloud()">‚òÅ Save</button>
  <button onclick="loadCloud()">‚¨á Load</button>
</header>

<div id="assets">
  <h4>Scenes</h4>
  <div id="sceneList"></div>
</div>

<canvas id="stage" width="420" height="260"></canvas>

<div id="inspector">
  <h4>Status</h4>
  <p>PWA ‚Ä¢ Offline Safe Mode</p>
</div>

<div id="timeline">
  Touch objects to move ‚Ä¢ Works offline ‚Ä¢ Installable PWA
</div>

<!-- SERVICE WORKER REGISTER -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
